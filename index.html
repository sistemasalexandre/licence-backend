<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Controle Financeiro - PATCH</title>
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f4f6f9;margin:0;padding-bottom:60px}
  .container{max-width:1100px;margin:20px auto;padding:12px}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(11,22,39,0.04);margin-bottom:16px}
  .btn{padding:8px 12px;border-radius:8px;border:none;color:#fff;cursor:pointer;font-weight:600;background:#246bff}
  .btn.secondary{background:#6c757d}
  .btn.danger{background:#e53935}
  .input, select{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #e6e9ee}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
  .dialog{background:#fff;padding:16px;border-radius:10px;width:520px;max-width:96%}
  #chartTooltip{position:fixed;pointer-events:none;background:rgba(0,0,0,0.85);color:#fff;padding:8px 10px;border-radius:6px;font-size:0.95rem;display:none;z-index:9999}
  footer{position:fixed;left:0;right:0;bottom:0;height:48px;background:#ffffffcc;display:flex;align-items:center;justify-content:center;border-top:1px solid #eee;font-size:0.95rem}
  .chart-mode{background:#246bff;border-radius:8px;color:#fff;padding:8px 12px;border:none;font-weight:600;cursor:pointer}
  .chart-mode.active{background:#e53935;color:#fff}
</style>

<style>
/* === Theme V2: Dark + animations === */
:root{
  --bg:#0b1220; --card:#0f1724; --text:#e6eef8; --muted:#94a3b8;
  --accent:#246bff; --danger:#e53935; --glass: rgba(255,255,255,0.03);
  --radius-xl:18px;
}
/* Light theme variables (used when .light-theme on body) */
body.light-theme{
  --bg:#f4f6f9; --card:#ffffff; --text:#0b1220; --muted:#6c757d; --glass: rgba(0,0,0,0.02);
}
/* Base */
body{background:var(--bg);color:var(--text);transition:background .35s ease,color .35s ease}
.card{background:var(--card);box-shadow:0 8px 30px rgba(2,6,23,0.35);border-radius:var(--radius-xl);transition:transform .18s ease,box-shadow .18s ease}
.topbar.card{display:flex;align-items:center;justify-content:space-between;padding:14px}
.btn{background:var(--accent);box-shadow:0 6px 18px rgba(36,107,255,0.08);transition:transform .12s ease,box-shadow .12s ease}
.btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06)}
.btn:active{transform:translateY(1px) scale(.998)}
.input,select{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06)}
table th, table td{border-bottom:1px solid rgba(255,255,255,0.03)}
/* modal animation */
.modal .dialog{transform:translateY(8px) scale(.99);opacity:0;transition:transform .28s cubic-bezier(.2,.9,.2,1),opacity .28s ease}
.modal.show .dialog{transform:translateY(0) scale(1);opacity:1}
/* toast */
.cf-toast{position:fixed;right:20px;bottom:20px;background:linear-gradient(90deg,var(--accent),#1fb3ff);color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.4);transform:translateY(12px);opacity:0;transition:transform .28s ease,opacity .28s ease;z-index:999999}
.cf-toast.show{transform:translateY(0);opacity:1}
/* table hover */
#tblTrans tbody tr:hover{transform:translateY(-4px);box-shadow:0 6px 18px rgba(2,6,23,0.18);background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
/* chart transitions */
#chartCanvas{transition:opacity .3s ease, transform .28s ease}
/* reduce motion preference */
@media (prefers-reduced-motion: reduce){
  *{transition:none!important;animation:none!important}
}
</style>
<style>
/* CF PATCH: modal dialog background in dark theme -> match Receita (blue gradient) */
body.dark-theme .modal .dialog{
  background: linear-gradient(90deg,#5b8def,#2bbbad) !important;
  color: #fff !important;
  box-shadow: 0 12px 40px rgba(11,22,39,0.5) !important;
}
/* Ensure inputs inside modal are visible on dark gradient */
body.dark-theme .modal .dialog .input,
body.dark-theme .modal .dialog select{
  background: rgba(255,255,255,0.06) !important;
  color: #fff !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
}
body.dark-theme .modal .dialog label{
  color: rgba(234,244,255,0.95) !important;
}
/* keep modal overlay slightly darker */
body.dark-theme .modal{ background: rgba(5,8,15,0.65) !important; }
</style>
</head>
<body>
<div class="container">
  <div class="topbar card" style="display:flex;align-items:center;justify-content:space-between">
    <h2 style="margin:0">Controle Financeiro</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="themeToggle" class="btn secondary" title="Alternar tema">üåô Tema</button>
    </div>
    
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnExportJson" class="btn">Efetuar BKP</button>
      <button id="btnImportJson" class="btn">Importar BKP</button>
      <button id="btnExportCsv" class="btn">Exportar CSV</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Resumo Mensal</strong></div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="selMonth" class="input" style="width:140px;display:inline-block"></select>
        <select id="selYear" class="input" style="width:140px;display:inline-block"></select>
      </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:14px">
      <div class="card" style="flex:1;background:linear-gradient(90deg,#5b8def,#2bbbad);color:#fff"><div>Receita</div><h3 id="txtReceita">R$ 0,00</h3></div>
      <div class="card" style="flex:1;background:linear-gradient(90deg,#ff7a7a,#ffb36b);color:#fff"><div>Despesas</div><h3 id="txtDespesa">R$ 0,00</h3></div>
      <div class="card" style="flex:1;background:linear-gradient(90deg,#6ee7b7,#34d399);color:#fff"><div>Saldo</div><h3 id="txtSaldo">R$ 0,00</h3></div>
      <div class="card" style="flex:1;background:linear-gradient(90deg,#9f7aea,#7c3aed);color:#fff"><div>Investimentos</div><h3 id="txtInvest">R$ 0,00</h3></div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Transa√ß√µes</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnAdd" class="btn">Adicionar</button>
        <button id="btnClear" class="btn danger">Limpar Tudo</button>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div style="min-width:260px">
        <input id="newCatName" class="input" placeholder="Nova categoria (ex: Lanches)">
      </div>
      <div style="min-width:200px">
        <select id="newCatType" class="input">
          <option value="despesa">Despesa</option>
          <option value="receita">Receita</option>
          <option value="investimento">Investimento</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnAddCat" class="btn">Criar Categoria</button>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <div style="min-width:260px">
        <select id="existingCats" class="input"></select>
      </div>
      <div style="min-width:200px">
        <button id="btnDelCat" class="btn danger">Excluir Categoria Selecionada</button>
      </div>
    </div>

    <table id="tblTrans" style="width:100%;margin-top:12px;border-collapse:collapse">
      <thead><tr><th style="text-align:left;padding:10px;border-bottom:1px solid #eee">Data</th><th style="padding:10px;border-bottom:1px solid #eee">Tipo</th><th style="padding:10px;border-bottom:1px solid #eee">Categoria</th><th style="padding:10px;border-bottom:1px solid #eee">Valor</th><th style="padding:10px;border-bottom:1px solid #eee">Descri√ß√£o</th><th style="padding:10px;border-bottom:1px solid #eee">Anexo</th><th style="padding:10px;border-bottom:1px solid #eee"></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Gr√°ficos</strong>
      <div style="display:flex;gap:8px">
        <button class="chart-mode" data-mode="despesa">Despesas</button>
        <button class="chart-mode" data-mode="receita">Receita</button>
        <button class="chart-mode" data-mode="investimento">Investimentos</button>
        <button class="chart-mode" data-mode="saldo">Saldo</button>
      </div>
    </div>
    <div style="position:relative;display:flex;gap:18px;align-items:flex-start">
      <canvas id="chartCanvas" width="600" height="360" style="background:transparent;border-radius:8px"></canvas>
      <div id="chartLegend" class="legend"></div>
      <div id="chartTooltip"></div>
    </div>
  </div>
</div>

<div class="modal" id="modal" aria-hidden="true">
  <div class="dialog">
    <h3 id="modalTitle">Adicionar transa√ß√£o</h3>
    <label>Tipo</label>
    <select id="mTipo" class="input"><option value="despesa">Despesa</option><option value="receita">Receita</option><option value="investimento">Investimento</option></select>
    <label>Categoria</label>
    <select id="mCat" class="input"></select>
    <label>Valor</label><input id="mValor" class="input" type="number" step="0.01">
    <label>Data</label><input id="mData" class="input" type="date">
    <label>Descri√ß√£o</label><input id="mDesc" class="input" type="text">
    <label>Anexo (PDF/Imagem)</label><input id="mFile" class="input" type="file" accept=".pdf,image/*">
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="btnSave" class="btn">Salvar</button>
      <button id="btnClose" class="btn secondary">Fechar</button>
    </div>
  </div>
</div>

<footer>Controle Financeiro V1 - Desenvolvido por Alexandre Mateus</footer>

<script>
// Patch: initialize on DOMContentLoaded and catch runtime errors to surface them to the user.
// This helps diagnose why "buttons stopped working".
window.addEventListener('error', function(e){
  // show a simple alert for any uncaught errors (helps debugging)
  try{ alert('Erro detectado: ' + (e && e.message ? e.message : e)); }catch(_){}
});

document.addEventListener('DOMContentLoaded', function(){
  try{
    (function(){
      const KEY = 'controle_financeiro_v1';
      const FILE_STORE = 'controle_financeiro_files_v1';
      let state = { categorias: [], transacoes: [] };
      let editingId = null;

      function openIdb(){ return new Promise((resolve,reject)=>{ if(!('indexedDB' in window)){ reject(new Error('IndexedDB n√£o dispon√≠vel')); return; } const r=indexedDB.open('controle_financeiro_v1',1); r.onupgradeneeded = e => { const db=e.target.result; if(!db.objectStoreNames.contains(FILE_STORE)) db.createObjectStore(FILE_STORE,{keyPath:'id'}); }; r.onsuccess = e => resolve(e.target.result); r.onerror = e => reject(e); }); }
      async function saveFile(id,file){ try{ const db=await openIdb(); const tx=db.transaction(FILE_STORE,'readwrite'); const store=tx.objectStore(FILE_STORE); return new Promise((res,rej)=>{ const rec={id,blob:file,name:file.name,type:file.type,created:Date.now()}; const req=store.put(rec); req.onsuccess=()=>{db.close();res(true)}; req.onerror=(e)=>{db.close();rej(e)}; }); }catch(e){ console.warn('saveFile: IndexedDB indispon√≠vel',e); throw e; } }
      async function getFile(id){ try{ const db=await openIdb(); return new Promise((res,rej)=>{ const tx=db.transaction(FILE_STORE,'readonly'); const store=tx.objectStore(FILE_STORE); const rq=store.get(id); rq.onsuccess=()=>{db.close();res(rq.result)}; rq.onerror=()=>{db.close();rej(rq.error)}; }); }catch(e){ console.warn('getFile: IndexedDB indispon√≠vel',e); return null; } }

      function $(id){ return document.getElementById(id); }
      function currency(v){ return 'R$ '+Number(v).toLocaleString('pt-BR',{minimumFractionDigits:2}); }

      function load(){ try{ const txt=localStorage.getItem(KEY); if(txt) state=JSON.parse(txt); if(!state.categorias || state.categorias.length===0) initDefaults(); renderCats(); renderExistingCats(); renderTable(); renderSummary(); renderChart(); setActiveChartButton(chartMode); }catch(e){ console.error(e); state={categorias:[],transacoes:[]}; initDefaults(); } }
      function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

      function initDefaults(){ const defs=[ ['Alimenta√ß√£o','despesa'],['Luz','despesa'],['Condom√≠nio','despesa'],['Cart√£o de Cr√©dito','despesa'],['Viagem','despesa'], ['Caixinha','investimento'],['A√ß√µes','investimento'],['Tesouro Direto','investimento'],['Fundos Imobili√°rios','investimento'], ['Sal√°rio','receita'],['Dividendos','receita'],['Outros','receita'] ]; state.categorias = defs.map((d,i)=>({id:'cat_'+i,nome:d[0],tipo:d[1]})); state.transacoes = state.transacoes || []; save(); }

      function renderCats(){ const sel=$('mCat'); if(!sel) return; sel.innerHTML=''; state.categorias.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.text=c.nome; sel.appendChild(o); }); }
      function renderExistingCats(){ const sel=$('existingCats'); if(!sel) return; sel.innerHTML=''; state.categorias.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.text=c.nome + ' ('+c.tipo+')'; sel.appendChild(o); }); }

      $('btnAddCat').onclick = function(){ const name = $('newCatName').value.trim(); const tipo = $('newCatType').value; if(!name){ alert('Digite o nome da categoria'); return; } const id = 'cat_'+Date.now(); state.categorias.push({id,nome:name,tipo:tipo}); save(); renderCats(); renderExistingCats(); $('newCatName').value=''; alert('Categoria criada: ' + name); };

      // delete category
      $('btnDelCat').onclick = function(){ const sel = $('existingCats'); if(!sel){ alert('Nenhuma categoria dispon√≠vel'); return; } const id = sel.value; if(!id){ alert('Selecione uma categoria para excluir'); return; } const cat = state.categorias.find(c=>c.id===id); if(!cat){ alert('Categoria n√£o encontrada'); return; } const related = state.transacoes.filter(t=>t.categoria_id===id); if(related.length>0){ if(!confirm('Essa categoria tem '+related.length+' transa√ß√µes. Ao excluir, essas transa√ß√µes ficar√£o sem categoria. Confirma excluir?')) return; state.transacoes = state.transacoes.map(t=> t.categoria_id===id ? Object.assign({},t,{categoria_id: null}) : t); } state.categorias = state.categorias.filter(c=>c.id!==id); save(); renderCats(); renderExistingCats(); renderTable(); renderSummary(); renderChart(); alert('Categoria exclu√≠da'); };

      function renderTable(){ const tbody = document.querySelector('#tblTrans tbody'); if(!tbody) return; tbody.innerHTML=''; const m=parseInt($('selMonth').value|| (new Date().getMonth()+1)), y=parseInt($('selYear').value|| new Date().getFullYear()); const trans = state.transacoes.filter(t=>{ const d=new Date(t.data); return d.getMonth()+1===m && d.getFullYear()===y; }).sort((a,b)=>b.data.localeCompare(a.data)); trans.forEach(t=>{ const tr=document.createElement('tr'); const cat = state.categorias.find(c=>c.id===t.categoria_id); const arquivoLink = t.arquivo?`<a href="#" class="link open-file" data-id="${t.arquivo}">Abrir</a>`:''; tr.innerHTML=`<td style="padding:10px">${t.data}</td><td style="padding:10px">${t.tipo}</td><td style="padding:10px">${cat?cat.nome:'Sem'}</td><td style="padding:10px">${currency(t.valor)}</td><td style="padding:10px">${t.descricao||''}</td><td style="padding:10px">${arquivoLink}</td><td style="padding:10px"><button class="btn edit-btn" data-id="${t.id}">Editar</button> <button class="btn danger del-btn" data-id="${t.id}">Excluir</button></td>`; tbody.appendChild(tr); }); // attach handlers safely
        Array.from(document.querySelectorAll('.del-btn')).forEach(b=>{ b.onclick=(e)=>{ const id=e.target.dataset.id; if(confirm('Excluir transa√ß√£o?')){ state.transacoes = state.transacoes.filter(x=>x.id!==id); save(); renderTable(); renderSummary(); renderChart(); } }; });
        Array.from(document.querySelectorAll('.edit-btn')).forEach(b=>{ b.onclick=(e)=>{ openModal(e.target.dataset.id); }; });
        Array.from(document.querySelectorAll('.open-file')).forEach(a=>a.onclick=async e=>{ e.preventDefault(); const id=e.target.dataset.id; try{ const rec=await getFile(id); if(rec && rec.blob){ const url=URL.createObjectURL(rec.blob); const w = window.open(); if(w){ if(rec.type && rec.type.startsWith('image/')){ w.document.write('<img src="'+url+'" style="max-width:100%"/>'); } else if(rec.type==='application/pdf'){ w.document.write('<iframe src="'+url+'" style="width:100%;height:100vh;border:none"></iframe>'); } else { w.location.href = url; } } else { window.location.href = url; } setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(e){} },30000); } else { alert('Arquivo n√£o encontrado'); } }catch(err){ console.error(err); alert('Arquivo n√£o encontrado'); } }); }

      function renderSummary(){ const m=parseInt($('selMonth').value|| (new Date().getMonth()+1)), y=parseInt($('selYear').value|| new Date().getFullYear()); const trans = state.transacoes.filter(t=>{ const d=new Date(t.data); return d.getMonth()+1===m && d.getFullYear()===y; }); let receita=0, despesa=0, invest=0; trans.forEach(t=>{ if(t.tipo==='receita') receita+=t.valor; else if(t.tipo==='despesa') despesa+=t.valor; else if(t.tipo==='investimento') invest+=t.valor; }); $('txtReceita').textContent=currency(receita); $('txtDespesa').textContent=currency(despesa); $('txtInvest').textContent=currency(invest); $('txtSaldo').textContent=currency(receita-despesa); }

      function fillMonthYear(){ const selM=$('selMonth'), selY=$('selYear'); if(!selM||!selY) return; selM.innerHTML=''; const months=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']; months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i+1; o.text=m; selM.appendChild(o); }); const y=new Date().getFullYear(); selY.innerHTML=''; for(let i=y-5;i<=y+5;i++){ const o=document.createElement('option'); o.value=i; o.text=i; selY.appendChild(o); } selM.value=new Date().getMonth()+1; selY.value=new Date().getFullYear(); selM.onchange=()=>{ renderTable(); renderSummary(); renderChart(); }; selY.onchange=()=>{ renderTable(); renderSummary(); renderChart(); }; }

      let chartMode='despesa'; const chartCanvas = $('chartCanvas'); const chartCtx = chartCanvas && chartCanvas.getContext? chartCanvas.getContext('2d') : null; let chartSlices = []; let hoverIndex = -1;
      function renderChart(){ if(!chartCtx) return; chartSlices = []; hoverIndex = -1; const m=parseInt($('selMonth').value|| (new Date().getMonth()+1)), y=parseInt($('selYear').value|| new Date().getFullYear()); const trans = state.transacoes.filter(t=>{ const d=new Date(t.data); return d.getMonth()+1===m && d.getFullYear()===y; }); const agg={}; if(chartMode==='saldo'){ let ganhos=0,gastos=0; trans.forEach(t=>{ if(t.tipo==='receita') ganhos+=t.valor; else if(t.tipo==='despesa') gastos+=t.valor; }); drawDonut(['Despesas','Receita'], [gastos, ganhos]); const saldo = ganhos - gastos; let legendHtml = ''; if(saldo >= 0){ legendHtml = '<div>Saldo: <span style="color:#2196f3;font-weight:700">+' + currency(saldo) + '</span></div>'; } else { legendHtml = '<div>Saldo: <span style="color:#e53935;font-weight:700">-' + currency(Math.abs(saldo)) + '</span></div>'; } const legend = $('chartLegend'); if(legend) legend.innerHTML = legendHtml; return; } trans.forEach(t=>{ if(t.tipo===chartMode){ const cat = (state.categorias.find(c=>c.id===t.categoria_id)||{nome:'Sem'}).nome; agg[cat] = (agg[cat]||0) + t.valor; }}); const labels = Object.keys(agg); const values = labels.map(l=>agg[l]); if(values.length===0){ drawDonut(['Sem dados'], [1]); const legend = $('chartLegend'); if(legend) legend.innerHTML=''; return; } drawDonut(labels, values); const legend = $('chartLegend'); if(legend) legend.innerHTML=''; }

      function drawDonut(labels, values){ if(!chartCtx) return; const ctx = chartCtx; const c = chartCanvas; ctx.clearRect(0,0,c.width,c.height); const total = values.reduce((a,b)=>a+b,0)||1; const cx = c.width/2, cy = c.height/2; const outerR = Math.min(c.width,c.height)/3; const innerR = outerR * 0.55; const shadowOffset = 8;
        ctx.save();
        ctx.translate(0, shadowOffset/2);
        ctx.beginPath(); ctx.ellipse(cx, cy, outerR, outerR*0.85, 0, 0, Math.PI*2); ctx.fillStyle = 'rgba(20,30,60,0.06)'; ctx.fill(); ctx.restore();
        let start = -0.5*Math.PI; chartSlices = [];
        for(let i=0;i<values.length;i++){ const v = values[i]; const slice = (v/total)*(Math.PI*2); const end = start + slice;
          const hue = (i*43)%360; const color1 = `hsl(${hue} 70% 55%)`; const color2 = `hsl(${(hue+20)%360} 70% 35%)`;
          const midAngle = start + slice/2; const grad = ctx.createLinearGradient(cx + Math.cos(midAngle)*innerR, cy + Math.sin(midAngle)*innerR, cx + Math.cos(midAngle)*outerR, cy + Math.sin(midAngle)*outerR);
          grad.addColorStop(0, color1); grad.addColorStop(1, color2);
          const isHover = (i === hoverIndex);
          const offset = isHover ? 10 : 0;
          const ox = Math.cos(midAngle) * offset; const oy = Math.sin(midAngle) * offset;
          ctx.beginPath();
          ctx.moveTo(cx + ox, cy + oy);
          ctx.arc(cx + ox, cy + oy, outerR, start, end);
          ctx.lineTo(cx + ox + Math.cos(end)*(innerR), cy + oy + Math.sin(end)*(innerR));
          ctx.arc(cx + ox, cy + oy, innerR, end, start, true);
          ctx.closePath();
          ctx.fillStyle = grad;
          ctx.fill();
          ctx.beginPath();
          ctx.arc(cx + ox, cy + oy, outerR, start, end);
          ctx.strokeStyle = 'rgba(255,255,255,0.08)';
          ctx.lineWidth = 1.2;
          ctx.stroke();
          chartSlices.push({start, end, label: labels[i], value: values[i], color: color1, mid: midAngle});
          start = end;
        }
        ctx.beginPath(); ctx.arc(cx, cy, innerR*0.96, 0, Math.PI*2); ctx.fillStyle = '#ffffff'; ctx.fill();
        ctx.fillStyle = '#333'; ctx.font = '600 16px Arial'; ctx.textAlign='center';
        ctx.fillText('Total', cx, cy-6);
        ctx.font = '700 18px Arial';
        ctx.fillText(currency(total), cx, cy+18);
      }

      const tooltip = $('chartTooltip');
      if(chartCanvas) {
        chartCanvas.addEventListener('mousemove', function(e){ const rect = chartCanvas.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const cx = chartCanvas.width/2, cy = chartCanvas.height/2; const dx = x - cx, dy = y - cy; const dist = Math.sqrt(dx*dx+dy*dy); let ang = Math.atan2(dy,dx); if(ang < -0.5*Math.PI) ang += Math.PI*2; const foundIdx = chartSlices.findIndex(s => ang >= s.start && ang <= s.end); if(foundIdx !== -1 && dist > (Math.min(chartCanvas.width, chartCanvas.height)/3)*0.55 && dist < (Math.min(chartCanvas.width, chartCanvas.height)/3)*1.05){ const found = chartSlices[foundIdx]; if(tooltip){ tooltip.style.display='block'; tooltip.style.left = (e.clientX + 12) + 'px'; tooltip.style.top = (e.clientY + 12) + 'px'; tooltip.innerHTML = `<div style="font-weight:700">${found.label}</div><div>${currency(found.value)}</div>`; } hoverIndex = foundIdx; renderChart(); } else { if(tooltip) tooltip.style.display='none'; if(hoverIndex !== -1){ hoverIndex = -1; renderChart(); } } });
        chartCanvas.addEventListener('mouseout', ()=>{ if(tooltip) tooltip.style.display='none'; if(hoverIndex !== -1){ hoverIndex = -1; renderChart(); } });
      }

      function openModal(editId){ editingId = editId || null; const modal = $('modal'); if(!modal) return; modal.style.display='flex'; $('modalTitle').textContent = editId ? 'Editar transa√ß√£o' : 'Adicionar transa√ß√£o'; if(editId){ const rec = state.transacoes.find(t=>t.id===editId); if(rec){ $('mTipo').value=rec.tipo; $('mCat').value=rec.categoria_id; $('mValor').value=rec.valor; $('mData').value=rec.data; $('mDesc').value=rec.descricao||''; } } else { $('mTipo').value='despesa'; $('mCat').value = state.categorias.length?state.categorias[0].id:''; $('mValor').value=''; $('mData').value=new Date().toISOString().slice(0,10); $('mDesc').value=''; try{ const mv = $('mValor'); if(mv) mv.focus(); }catch(_){} } }
      function closeModal(){ const modal=$('modal'); if(modal) modal.style.display='none'; editingId=null; const f=$('mFile'); if(f) f.value=''; }

      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ const modal=$('modal'); if(modal && modal.style.display==='flex') closeModal(); } });

      $('btnClose').onclick = closeModal;
      $('btnSave').onclick = async function(){ try{ const tipo=$('mTipo').value; const cid=$('mCat').value; const valor=parseFloat($('mValor').value); const dataStr=$('mData').value; const desc=$('mDesc').value; if(!cid){ alert('Escolha categoria'); return; } if(isNaN(valor)||valor<=0){ alert('Valor inv√°lido'); return; } let fileId=null; const f=$('mFile').files[0]; if(f){ fileId='f_'+Date.now(); try{ await saveFile(fileId,f); }catch(e){ console.error(e); alert('Falha ao salvar arquivo (IndexedDB)'); fileId=null; } } if(editingId){ const idx=state.transacoes.findIndex(t=>t.id===editingId); if(idx>=0){ state.transacoes[idx].tipo=tipo; state.transacoes[idx].categoria_id=cid; state.transacoes[idx].valor=valor; state.transacoes[idx].data=dataStr; state.transacoes[idx].descricao=desc; if(fileId) state.transacoes[idx].arquivo=fileId; } }else{ const id='t_'+Date.now(); state.transacoes.push({id,tipo,categoria_id:cid,valor,data:dataStr,descricao:desc,arquivo:fileId}); } save(); renderTable(); renderSummary(); renderChart(); closeModal(); }catch(e){ console.error(e); alert('Erro: '+(e && e.message? e.message : e)); } };

      $('btnExportJson').onclick = function(){ try{ const blob = new Blob([JSON.stringify(state)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='controle_financeiro_backup.json'; a.click(); setTimeout(()=>{ try{ URL.revokeObjectURL(url);}catch(e){} },1000); }catch(e){ alert('Erro ao exportar: '+e.message); } };
      $('btnExportCsv').onclick = function(){ try{ let csv = 'data,tipo,categoria,valor,descricao,arquivo\n'; state.transacoes.forEach(t=>{ const cat=(state.categorias.find(c=>c.id===t.categoria_id)||{nome:''}).nome; csv+=`"${t.data}","${t.tipo}","${cat}",${t.valor},"${(t.descricao||'').replace(/"/g,'""')}","${t.arquivo||''}"\n`; }); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='controle_financeiro.csv'; a.click(); setTimeout(()=>{ try{ URL.revokeObjectURL(url);}catch(e){} },1000); }catch(e){ alert('Erro ao exportar CSV: '+e.message); } };
      $('btnImportJson').onclick = function(){ try{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json'; inp.onchange=()=>{ const f=inp.files[0]; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.categorias && obj.transacoes){ state=obj; save(); load(); alert('Importado'); } else alert('Formato inv√°lido'); }catch(e){ alert('Erro ao importar: '+(e && e.message?e.message:e)); } }; r.readAsText(f); }; inp.click(); }catch(e){ alert('Erro ao iniciar import: '+e.message); } };

      $('btnClear').onclick = function(){ if(confirm('Apagar TODOS os dados locais?')){ state={categorias:[],transacoes:[]}; initDefaults(); save(); load(); } };

      function setActiveChartButton(mode){
        document.querySelectorAll('.chart-mode').forEach(b=>{
          if(b.dataset.mode===mode){ b.classList.add('active'); } else { b.classList.remove('active'); }
        });
      }

      Array.from(document.querySelectorAll('.chart-mode')).forEach(b=>b.addEventListener('click', (e)=>{ const mode=e.currentTarget.dataset.mode; chartMode=mode; setActiveChartButton(mode); renderChart(); }));

      $('btnAdd').onclick = ()=> openModal();
      fillMonthYear();
      setActiveChartButton(chartMode);
      load();
    })();
  }catch(e){
    console.error('Erro na inicializa√ß√£o:', e);
    alert('Erro na inicializa√ß√£o do app: ' + (e && e.message? e.message : e));
  }
});
</script>

<script>
// === V2 Enhancements: theme toggle, toasts, animations ===
(function(){
  const body = document.body;
  const THEME_KEY = 'cf_theme_v2';
  function prefersDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
  // init theme
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === 'light') body.classList.remove('dark-theme');
  if(saved === 'dark') body.classList.add('dark-theme');
  if(!saved){ if(prefersDark()) body.classList.add('dark-theme'); else body.classList.add('light-theme'); }
  // toggle button
  const tBtn = document.getElementById('themeToggle');
  if(tBtn){
    function updateBtn(){ tBtn.textContent = body.classList.contains('light-theme') ? 'üåô Tema' : '‚òÄÔ∏è Tema'; }
    tBtn.addEventListener('click', ()=>{
      if(body.classList.contains('light-theme')){ body.classList.remove('light-theme'); body.classList.add('dark-theme'); localStorage.setItem(THEME_KEY,'dark'); }
      else { body.classList.remove('dark-theme'); body.classList.add('light-theme'); localStorage.setItem(THEME_KEY,'light'); }
      updateBtn();
    });
    updateBtn();
  }

  // simple toast helper
  window.cf_toast = function(msg, timeout=2600){
    const el = document.createElement('div');
    el.className = 'cf-toast';
    el.textContent = msg;
    document.body.appendChild(el);
    // force reflow then show
    requestAnimationFrame(()=> el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),300); }, timeout);
  };

  // countUp for numbers (animates numeric value)
  window.cf_countUp = function(el, start, end, duration=700){
    if(!el) return;
    if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){ el.textContent = end.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); return; }
    const range = end - start; const startTime = performance.now();
    function frame(now){
      const t = Math.min(1, (now - startTime)/duration);
      const v = Math.round(start + range * t);
      el.textContent = v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
      if(t < 1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  };

  // button ripple effect (light)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn');
    if(!btn) return;
    const rect = btn.getBoundingClientRect();
    const ripple = document.createElement('span');
    const size = Math.max(rect.width, rect.height);
    Object.assign(ripple.style, {
      position: 'absolute', left: (e.clientX - rect.left - size/2)+'px', top: (e.clientY - rect.top - size/2)+'px',
      width: size+'px', height: size+'px', borderRadius: '50%', background: 'rgba(255,255,255,0.12)', transform:'scale(0)', transition:'transform .45s ease, opacity .6s ease', pointerEvents:'none'
    });
    ripple.className = 'cf-ripple';
    btn.style.position = btn.style.position || 'relative';
    btn.appendChild(ripple);
    requestAnimationFrame(()=> ripple.style.transform = 'scale(1)');
    setTimeout(()=> { ripple.style.opacity = '0'; setTimeout(()=> ripple.remove(), 700); }, 600);
  }, true);

  // modal animation: add show class on open/close
  const modal = document.getElementById('modal');
  const originalOpen = window.openModal;
  const originalClose = window.closeModal;
  window.openModal = function(id){ if(typeof originalOpen === 'function') originalOpen(id); if(modal) modal.classList.add('show'); };
  window.closeModal = function(){ if(typeof originalClose === 'function') originalClose(); if(modal) modal.classList.remove('show'); };

  // wrap renderSummary to add countUp animations
  const originalRenderSummary = window.renderSummary;
  window.renderSummary = function(){
    try{
      if(typeof originalRenderSummary === 'function') originalRenderSummary();
      const r = document.getElementById('txtReceita'), d=document.getElementById('txtDespesa'), s=document.getElementById('txtSaldo'), i=document.getElementById('txtInvest');
      const parseCurrency = t=> Number(t.textContent.replace(/[^\d,-]+/g,'').replace(',','.')) || 0;
      // read numeric values from state via DOM (fallback)
      const rv = (r && r.textContent)? Number(r.textContent.replace(/[^\d,-]+/g,''))/100 : 0;
      // Instead of attempting to parse, we'll get numbers from localStorage state
      try{
        const state = JSON.parse(localStorage.getItem('controle_financeiro_v1')||'{"categorias":[],"transacoes":[]}');
        const m = parseInt(document.getElementById('selMonth').value|| (new Date().getMonth()+1));
        const y = parseInt(document.getElementById('selYear').value|| new Date().getFullYear());
        let receita=0, despesa=0, invest=0;
        (state.transacoes||[]).filter(t=>{ const d=new Date(t.data); return d.getMonth()+1===m && d.getFullYear()===y; }).forEach(t=>{ if(t.tipo==='receita') receita+=Number(t.valor||0); else if(t.tipo==='despesa') despesa+=Number(t.valor||0); else if(t.tipo==='investimento') invest+=Number(t.valor||0); });
        window.cf_countUp(document.getElementById('txtReceita'), 0, receita, 700);
        window.cf_countUp(document.getElementById('txtDespesa'), 0, despesa, 700);
        window.cf_countUp(document.getElementById('txtInvest'), 0, invest, 700);
        const saldo = receita - despesa;
        // display with sign handled by originalRenderSummary; animate numeric part
        const saldoEl = document.getElementById('txtSaldo');
        // animate numeric value inside
        const start = 0, end = Math.round(saldo);
        if(saldoEl){ window.cf_countUp(saldoEl, start, end, 700); saldoEl.style.color = saldo>=0? 'rgb(36,107,255)' : 'rgb(229,57,53)'; }
      }catch(err){ /* ignore */ }
    }catch(e){ console.warn('renderSummary wrapper error', e); }
  };

  // wrap renderChart to add small reveal animation: fade in and slight scale
  const originalRenderChart = window.renderChart;
  window.renderChart = function(){
    try{
      const canvas = document.getElementById('chartCanvas');
      if(canvas){ canvas.style.opacity = '0'; canvas.style.transform = 'scale(.98)'; }
      if(typeof originalRenderChart === 'function') originalRenderChart();
      // animate in
      requestAnimationFrame(()=>{ const c=document.getElementById('chartCanvas'); if(c){ c.style.transition='opacity .36s ease, transform .36s cubic-bezier(.2,.9,.2,1)'; c.style.opacity='1'; c.style.transform='scale(1)'; } });
    }catch(e){ console.warn('renderChart wrapper error', e); if(typeof originalRenderChart==='function') originalRenderChart(); }
  };

  // small utility: show toast on create/delete category
  const btnAddCat = document.getElementById('btnAddCat');
  const btnDelCat = document.getElementById('btnDelCat');
  if(btnAddCat){ btnAddCat.addEventListener('click', ()=> setTimeout(()=> window.cf_toast('Categoria criada'), 400)); }
  if(btnDelCat){ btnDelCat.addEventListener('click', ()=> setTimeout(()=> window.cf_toast('Categoria exclu√≠da'), 400)); }

  // ensure initial call to wrapped functions after a short delay to show animations on load
  setTimeout(()=>{ try{ window.renderSummary && window.renderSummary(); window.renderChart && window.renderChart(); }catch(e){} }, 400);

})();
</script>

<!-- CF-BUTTON-FIX-START -->
<script>
/* Minimal non-invasive button fix: reattach Add and Edit handlers without touching other scripts or animations.
   Idempotent: will not re-add if already installed. */
(function(){
  if(window.__cf_button_fix_installed) return;
  window.__cf_button_fix_installed = true;

  function openFallback(id){
    try{
      if(window.openModal && typeof window.openModal === 'function'){ window.openModal(id); return; }
      if(typeof openModal === 'function'){ openModal(id); return; }
      // fallback: show modal and try to populate from localStorage
      const modal = document.getElementById('modal');
      if(!modal) return;
      modal.style.display = 'flex';
      const titleEl = document.getElementById('modalTitle');
      if(titleEl) titleEl.textContent = id ? 'Editar transa√ß√£o' : 'Adicionar transa√ß√£o';
      if(id){
        try{
          const state = JSON.parse(localStorage.getItem('controle_financeiro_v1')||'{"categorias":[],"transacoes":[]}');
          const rec = (state.transacoes||[]).find(t=>t.id===id);
          if(rec){
            try{ document.getElementById('mTipo').value = rec.tipo || 'despesa'; }catch(e){}
            try{ document.getElementById('mCat').value = rec.categoria_id || ''; }catch(e){}
            try{ document.getElementById('mValor').value = rec.valor; }catch(e){}
            try{ document.getElementById('mData').value = rec.data || new Date().toISOString().slice(0,10); }catch(e){}
            try{ document.getElementById('mDesc').value = rec.descricao || ''; }catch(e){}
            window._cf_forced_editingId = id;
          }
        }catch(e){ console.warn('CF button fix: error populating modal', e); }
      } else {
        try{ document.getElementById('mTipo').value = 'despesa'; }catch(e){}
        try{
          const cats = (JSON.parse(localStorage.getItem('controle_financeiro_v1')||'{"categorias":[]}').categorias||[]);
          if(cats && cats[0]) document.getElementById('mCat').value = cats[0].id;
        }catch(e){}
        try{ document.getElementById('mValor').value = ''; }catch(e){};
        try{ document.getElementById('mData').value = new Date().toISOString().slice(0,10); }catch(e){};
        try{ document.getElementById('mDesc').value = ''; }catch(e){};
      }
    }catch(e){ console.error('CF button fix openFallback error', e); }
  }

  function attachAdd(){
    const btn = document.getElementById('btnAdd');
    if(!btn) return;
    try{ btn.removeEventListener('click', window.__cf_add_handler); }catch(e){}
    window.__cf_add_handler = function(ev){ ev && ev.preventDefault && ev.preventDefault(); openFallback(); };
    btn.addEventListener('click', window.__cf_add_handler);
  }

  function attachEditDelegation(){
    try{ document.removeEventListener('click', window.__cf_edit_delegation, true); }catch(e){}
    window.__cf_edit_delegation = function(ev){
      const el = ev.target && ev.target.closest && ev.target.closest('.edit-btn');
      if(!el) return;
      ev.preventDefault();
      const id = el.dataset && el.dataset.id;
      openFallback(id);
    };
    document.addEventListener('click', window.__cf_edit_delegation, true);
  }

  function attachSaveShim(){
    const btnSave = document.getElementById('btnSave');
    if(!btnSave) return;
    if(btnSave.__cf_wrapped) return;
    btnSave.__cf_wrapped = true;
    btnSave.addEventListener('click', function(){
      if(window._cf_forced_editingId){
        try{ window.editingId = window._cf_forced_editingId; }catch(e){};
      }
    }, {capture:true});
  }

  function init(){
    attachAdd();
    attachEditDelegation();
    attachSaveShim();
    // observe table body to reattach if rows change
    try{
      const tbody = document.querySelector('#tblTrans tbody');
      if(tbody && !tbody.__cf_observer_installed){
        const mo = new MutationObserver(function(){ attachAdd(); attachEditDelegation(); attachSaveShim(); });
        mo.observe(tbody, { childList: true, subtree: true });
        tbody.__cf_observer_installed = true;
      }
    }catch(e){}
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  // also run shortly after to ensure compatibility with other scripts that run after load
  setTimeout(init, 300);
  console.log('CF button fix installed (non-invasive)');
})();
</script>
<!-- CF-BUTTON-FIX-END -->

</body>
</html>
