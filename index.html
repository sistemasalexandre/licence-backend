// server/index.js
// Reference image (for your debug): file:///mnt/data/0a4f4c0f-4777-460a-86ab-eaa95d7c55f2.png

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const bcrypt = require('bcryptjs');
const { createClient } = require('@supabase/supabase-js');
const Stripe = require('stripe');
const crypto = require('crypto');

const app = express();
app.use(express.json({ limit: '1mb' }));
app.use(cors({ origin: process.env.ALLOWED_ORIGIN || '*' }));

const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE;
const STRIPE_SECRET_KEY = process.env.STRIPE_SECRET_KEY;
const STRIPE_WEBHOOK_SECRET = process.env.STRIPE_WEBHOOK_SECRET; // optional, but recommended
const FRONTEND_URL = process.env.FRONTEND_URL || '';

if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE) {
  console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE in env');
  process.exit(1);
}
if (!STRIPE_SECRET_KEY) {
  console.warn('Warning: STRIPE_SECRET_KEY not set. Payments will fail.');
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);
const stripe = STRIPE_SECRET_KEY ? Stripe(STRIPE_SECRET_KEY) : null;

function genLicenseCode(prefix = ''){
  // generate an easy-to-read license code like ABCD-1234-EFGH
  const part = () => crypto.randomBytes(2).toString('hex').toUpperCase();
  return (prefix ? prefix + '-' : '') + `${part()}-${part()}-${part()}`;
}

/* Health */
app.get('/', (req, res) => res.send('Licence backend OK'));

/* ---------- AUTH endpoints (register/login) ---------- */
app.post('/api/register', async (req, res) => {
  try {
    const { email, password, name } = req.body;
    if (!email || !password) return res.status(400).json({ error: 'Email e senha obrigatórios' });

    // check existing
    const { data: exists } = await supabase.from('users').select('id').eq('email', email).limit(1);
    if (exists && exists.length) return res.status(400).json({ error: 'Usuário já existe' });

    const hash = await bcrypt.hash(password, 10);
    const payload = { email, password_hash: hash };
    if (name) payload.name = name;

    const { data, error } = await supabase.from('users').insert([payload]).select();
    if (error) throw error;
    const user = data[0];
    res.json({ ok: true, user: { id: user.id, email: user.email } });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message || 'erro' });
  }
});

app.post('/api/login', async (req, res) => {
  try {
    const { email, password } = req.body;
    if (!email || !password) return res.status(400).json({ error: 'Email e senha obrigatórios' });

    const { data } = await supabase.from('users').select('*').eq('email', email).limit(1);
    const user = data && data[0];
    if (!user) return res.status(400).json({ error: 'Usuário não encontrado' });

    const ok = await bcrypt.compare(password, user.password_hash);
    if (!ok) return res.status(401).json({ error: 'Senha incorreta' });

    // check license association
    const { data: ul } = await supabase.from('user_licenses').select('*').eq('user_email', email).limit(1);
    const hasLicense = ul && ul.length > 0;

    res.json({ ok: true, user: { id: user.id, email: user.email }, hasLicense: !!hasLicense });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message || 'erro' });
  }
});

/* ---------- Activate license by code (associate to user email) ---------- */
app.post('/api/activate-license', async (req, res) => {
  try {
    const { email, code } = req.body;
    if (!email || !code) return res.status(400).json({ error: 'email e code necessários' });

    // find license by code
    const { data: licData, error: errLic } = await supabase.from('licenses').select('*').eq('code', code).limit(1);
    if (errLic) throw errLic;
    const license = licData && licData[0];
    if (!license) return res.status(400).json({ error: 'Licença não encontrada' });
    if (license.status && license.status !== 'available' && license.status !== 'unused' && license.status !== 'reserved') {
      return res.status(400).json({ error: 'Licença não disponível' });
    }

    // insert association (avoid duplicates)
    const licenseKey = license.license_key ?? license.code;
    const { data: existing } = await supabase.from('user_licenses').select('id').eq('user_email', email).eq('license_key', licenseKey).limit(1);
    if (!existing || !existing.length) {
      const { error: errIns } = await supabase.from('user_licenses').insert([{ user_email: email, license_key: licenseKey }]);
      if (errIns) throw errIns;
    }

    // update license status
    const { error: errUpd } = await supabase.from('licenses').update({ status: 'used', used_by: email, used_at: new Date().toISOString() }).eq('code', code);
    if (errUpd) throw errUpd;

    res.json({ ok: true });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message || 'erro' });
  }
});

/* ---------- Create Stripe Checkout Session ---------- */
app.post('/api/create-checkout-session', async (req, res) => {
  try {
    if (!stripe) return res.status(500).json({ error: 'Stripe not configured' });
    const { priceId, customerEmail } = req.body;
    if (!priceId) return res.status(400).json({ error: 'priceId required' });

    // create a license record in DB as reserved so we have a code to attach
    const code = genLicenseCode();
    const licensePayload = { code, license_key: code, status: 'reserved', created_at: new Date().toISOString() };
    const { data: licInsert, error: errLic } = await supabase.from('licenses').insert([licensePayload]).select();
    if (errLic) throw errLic;
    const license = licInsert && licInsert[0];

    const sessionPayload = {
      payment_method_types: ['card'],
      mode: 'payment',
      line_items: [{ price: priceId, quantity: 1 }],
      success_url: (FRONTEND_URL || 'https://your-frontend.com') + '/auth.html?success=1',
      cancel_url: (FRONTEND_URL || 'https://your-frontend.com') + '/auth.html?cancel=1',
      // include the license code and optionally the customer email as metadata
      metadata: { license_code: license.code }
    };
    if (customerEmail) sessionPayload.customer_email = customerEmail;

    const session = await stripe.checkout.sessions.create(sessionPayload);

    res.json({ ok: true, url: session.url });
  } catch (err) {
    console.error('create-checkout-session error', err);
    res.status(500).json({ error: err.message || 'erro' });
  }
});

/* ---------- Stripe webhook to finalize purchase ---------- */
// raw body middleware for webhook verification
app.post('/webhook', express.raw({ type: 'application/json' }), async (req, res) => {
  try {
    if (!stripe) return res.status(500).send('Stripe not configured');
    const sig = req.headers['stripe-signature'];
    let event;
    try {
      if (STRIPE_WEBHOOK_SECRET) {
        event = stripe.webhooks.constructEvent(req.body, sig, STRIPE_WEBHOOK_SECRET);
      } else {
        // unsafe fallback (if webhook secret not set) - try to parse
        event = JSON.parse(req.body.toString());
      }
    } catch (err) {
      console.error('Webhook signature verification failed.', err.message);
      return res.status(400).send(`Webhook Error: ${err.message}`);
    }

    if (event.type === 'checkout.session.completed') {
      const session = event.data.object;
      const license_code = session.metadata && session.metadata.license_code;
      const customer_email = session.customer_email || session.customer || null;

      if (license_code) {
        // mark license used and attach to user if exists
        // find license record
        const { data: lic } = await supabase.from('licenses').select('*').eq('code', license_code).limit(1);
        const license = lic && lic[0];
        if (license) {
          // update license status
          await supabase.from('licenses').update({ status: 'used', used_by: customer_email || null, used_at: new Date().toISOString() }).eq('code', license_code);

          // if there's a user with this email, associate it
          if (customer_email) {
            const { data: u } = await supabase.from('users').select('*').eq('email', customer_email).limit(1);
            const user = u && u[0];
            const licenseKey = license.license_key ?? license.code;
            if (user) {
              // insert into user_licenses
              await supabase.from('user_licenses').insert([{ user_email: customer_email, license_key: licenseKey }]);
            } else {
              // no user yet - keep used_by as email so later activation can link
            }
          }
        }
      }
    }

    res.json({ received: true });
  } catch (err) {
    console.error('webhook handler error', err);
    res.status(500).send('Webhook processing error');
  }
});

/* ---------- Utility endpoints for debug (optional) ---------- */
app.get('/api/licenses', async (req, res) => {
  try {
    const { data, error } = await supabase.from('licenses').select('*').order('created_at', { ascending: false }).limit(50);
    if (error) throw error;
    res.json({ ok: true, licenses: data });
  } catch (err) { console.error(err); res.status(500).json({ error: err.message }); }
});

/* ---------- Start ---------- */
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server rodando na porta ${PORT}`));
